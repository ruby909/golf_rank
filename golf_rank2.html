<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°é¢é«˜çˆ¾å¤«æ¯”è³½è¨˜åˆ†æ¿</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        table { width: 90%; margin: 20px auto; border-collapse: collapse; }
        th, td { border: 1px solid black; padding: 10px; text-align: center; }
        th { background-color: #f2f2f2; }
        input { width: 80px; text-align: center; margin: 5px; }
        button { margin: 10px; padding: 10px; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>

    <h2>ğŸŒï¸ åœ°é¢é«˜çˆ¾å¤«æ¯”è³½è¨˜åˆ†æ¿ ğŸŒï¸â€â™€ï¸</h2>

    <table id="golfTable">
        <thead>
            <tr>
                <th>åæ¬¡</th>
                <th>çµ„åˆ¥</th>
                <th>æ¢¯æ¬¡</th>
                <th>å§“å</th>
                <th>å‡ºç”Ÿæ°‘åœ‹å¹´</th>
                <th>å‡ºç”Ÿæœˆ</th>
                <th>å‡ºç”Ÿæ—¥</th>
                <th>çƒè³½1æˆç¸¾</th>
                <th>çƒè³½2æˆç¸¾</th>
                <th>ç¸½åˆ†</th>
                <th>ä¸€æ¡¿é€²æ´æ¬¡æ•¸</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="tableBody"></tbody>
    </table>

    <button onclick="loadData()">ğŸ”„ é‡æ–°è¼‰å…¥è³‡æ–™</button>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbzMXMYxWPyE8o5RZfMDjdrctAFXKU_HqNuZGCXo005hQ6epHx2zGgd4wvM8lMfsONWa/exec";

        async function loadData() {
            try {
                let response = await fetch(scriptURL);
                let players = await response.json();

                // ä¾ç…§é †åºæ’åˆ—ï¼Œä½†ä¸é¡¯ç¤ºé †åºæ¬„ä½
                players.sort((a, b) => a.order - b.order);

                let tableBody = document.getElementById("tableBody");
                tableBody.innerHTML = "";

                players.forEach((player, index) => {
                    let row = tableBody.insertRow();
                    row.insertCell(0).innerText = index + 1;
                    row.insertCell(1).innerText = player.group;
                    row.insertCell(2).innerText = player.round;
                    row.insertCell(3).innerText = player.name;
                    row.insertCell(4).innerText = player.birthYear;
                    row.insertCell(5).innerText = player.birthMonth;
                    row.insertCell(6).innerText = player.birthDay;

                    let score1Cell = row.insertCell(7);
                    let score1Input = document.createElement("input");
                    score1Input.type = "number";
                    score1Input.value = player.score1;
                    score1Input.oninput = () => checkAndUpdateRanking();
                    score1Cell.appendChild(score1Input);

                    let score2Cell = row.insertCell(8);
                    let score2Input = document.createElement("input");
                    score2Input.type = "number";
                    score2Input.value = player.score2;
                    score2Input.oninput = () => checkAndUpdateRanking();
                    score2Cell.appendChild(score2Input);

                    let totalCell = row.insertCell(9);
                    totalCell.innerText = player.score1 + player.score2;

                    let holeInOneCell = row.insertCell(10);
                    let holeInOneInput = document.createElement("input");
                    holeInOneInput.type = "number";
                    holeInOneInput.value = player.holeInOne;
                    holeInOneInput.oninput = () => checkAndUpdateRanking();
                    holeInOneCell.appendChild(holeInOneInput);

                    let actionCell = row.insertCell(11);
                    let saveButton = document.createElement("button");
                    saveButton.innerText = "æäº¤";
                    saveButton.onclick = () => saveData(
                        player, 
                        score1Input.value, 
                        score2Input.value, 
                        holeInOneInput.value
                    );
                    actionCell.appendChild(saveButton);
                });

            } catch (error) {
                console.error("è®€å–è³‡æ–™éŒ¯èª¤ï¼š", error);
                alert("ç„¡æ³•è¼‰å…¥è³‡æ–™ï¼Œè«‹æª¢æŸ¥ Google Apps Script æœå‹™");
            }
        }

        function checkAndUpdateRanking() {
            let rows = [...document.querySelectorAll("#tableBody tr")];
            let allFilled = rows.every(row => 
                row.cells[7].firstChild.value &&
                row.cells[8].firstChild.value &&
                row.cells[10].firstChild.value
            );
            if (allFilled) updateRanking();
        }

        function updateRanking() {
            let rows = [...document.querySelectorAll("#tableBody tr")];
            let players = rows.map(row => ({
                row,
                score1: Number(row.cells[7].firstChild.value) || 0,
                score2: Number(row.cells[8].firstChild.value) || 0,
                holeInOne: Number(row.cells[10].firstChild.value) || 0,
                birthYear: Number(row.cells[4].innerText),
                birthMonth: Number(row.cells[5].innerText),
                birthDay: Number(row.cells[6].innerText)
            }));

            players.sort((a, b) => 
                (a.score1 + a.score2) - (b.score1 + b.score2) ||
                b.holeInOne - a.holeInOne ||
                b.birthYear - a.birthYear ||
                a.birthMonth - b.birthMonth ||
                a.birthDay - b.birthDay
            );

            players.forEach((player, index) => {
                player.row.cells[0].innerText = index + 1;
            });
        }

        async function saveData(player, score1, score2, holeInOne) {
            let formData = new FormData();
            formData.append("action", "update");
            formData.append("name", player.name);
            formData.append("score1", score1);
            formData.append("score2", score2);
            formData.append("holeInOne", holeInOne);

            try {
                let response = await fetch(scriptURL, { method: "POST", body: formData });
                let result = await response.text();
                alert(result);
                loadData();
            } catch (error) {
                console.error("æäº¤å¤±æ•—ï¼š", error);
                alert("æäº¤å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Google Apps Script");
            }
        }

        window.onload = loadData;
    </script>

</body>
</html>